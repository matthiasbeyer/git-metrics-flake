# git-metrics-flake

This flake allows a user to build CI scripts and nix tooling for the awesome
[git-metrics] tool.

## The idea

The basic idea here is that the user can have something like this in their flake:

```nix
{
apps.git-metrics-ci-script = let
  gm = inputs.git-metrics-flake;

  customMetric = gm.lib.buildMetric {
    name = "my-custom-metric";
    tags = {
      tagName = "some-tag-value";
    };
    text = ''
      # script to generate some metric
    '';
  };
in
  # Generate a script that adds metrics
  gm.lib.buildCiScript {
    # Allows overwriting `pkgs`
    # inherit pkgs;

    # Allows overwriting the `git-metrics` package
    # git-metrics = pkgs.git-metrics;

    # check whether the metrics are allowed by the rules defined in the
    # `/.git-metrics.toml` file.
    doCheck = true;

    # Define the list of metrics to be generated by the CI script
    metrics = [
      # Generate a metric "binary_size" for `packages.myPackage`
      (gm.metrics.binary_size { drv = packages.myPackage; })

      # Generate a metric "rust_version" for the package
      (gm.metrics.rust_version { drv = packages.myPackage; })

      # Generate a custom metric for the package
      (customMetric { drv = packages.myPackage; })
    ];
  };
}
```

And in CI, the user can call that generated script to add the metrics to their repository.
Note that push-access from CI is necessary to publish the metrics.

## Current status

WIP, not usable.

## License

MIT, (c) 2025 Matthias Beyer

[git-metrics]: https://github.com/jdrouet/git-metrics
